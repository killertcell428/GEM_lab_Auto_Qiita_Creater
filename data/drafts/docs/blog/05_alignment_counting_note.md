# vol.5 リードを遺伝子にマッピングする：RNA-seq解析の核心

## はじめに

前回は、14遺伝子の物語と、polyesterによるRNA-seqリードの生成についてお話ししました。今回は、生成したリードを**アライメント（マッピング）**し、**カウント（リード数を数える）**する過程について、その理論的背景と意味を深掘りしてみましょう。

RNA-seq解析の核心は、**「リード配列をリファレンス配列にマッピングし、各遺伝子にマップされたリード数を数える」**ことです。これにより、遺伝子発現量を定量化できます。

「アライメントって、どういう仕組みなの？」「なぜマッピング率が99.99%なのか？」「リードカウントとは何か？」

これらの疑問に答えながら、RNA-seq解析の核心を覗いてみましょう。

---

## アライメントとは何か？

### リードを遺伝子にマッピングする

**アライメント（マッピング）**は、**リード配列をリファレンス配列（ゲノムやトランスクリプト）に「どこに位置するか」を特定する**処理です。

RNA-seqリードは、どの遺伝子から来たのかが分かりません。アライメントすることで、各リードがどの遺伝子に対応するかを特定できます。

これは、**「パズルのピースを、完成図と照らし合わせる」**ようなものです。完成図（リファレンス配列）があって初めて、ピース（リード）がどこに属するのかが分かります。

<!-- 図1挿入位置：左にバラバラの短いリード断片、右にトランスクリプト（長いリファレンス配列）を描き、矢印で「ピースが元の位置にはまりに行く」様子を示したアライメント概念図。 -->

### なぜアライメントが必要なのか？

アライメントは、RNA-seq解析の**最初のステップ**です。

アライメントにより：
- **各リードがどの遺伝子から来たのか**を特定できる
- **遺伝子ごとのリード数を数える**ことで、発現量を定量化できる
- **発現量の差**を検出できる

つまり、アライメントなくして、RNA-seq解析は成立しません。

---

## HISAT2という高速マッピングツール

### なぜ高速なのか？

**HISAT2**は、RNA-seqリードをゲノムやトランスクリプトにマッピングするツールです。

HISAT2の特徴は、**高速**であることです。なぜ高速なのか？

HISAT2は、**インデックス**という仕組みを使います。リファレンス配列を事前にインデックス化することで、「この配列はどこにあるか」を素早く検索できます。

これは、**「本の索引を使う」**ようなものです。索引があれば、特定の単語を素早く見つけられます。インデックスがあれば、特定の配列を素早く見つけられます。

<!-- 図2挿入位置：「分厚い本」と「索引カード」の比喩図。本をリファレンス配列、索引をHISAT2インデックスとして描き、「全文検索ではなく索引で一気に場所を特定する」イメージを示す。 -->

👉 **HISAT2の詳細を学ぶ**：
- [初心者向けHISAT2解説（note）](https://note.com/ozk7311/n/n0c348ec05c6e) - コマンドの意味や役割を丁寧に解説したガイド
- [HISAT2 Biocondaパッケージページ](https://bioconda.github.io/recipes/hisat2/README.html) - 実際のインストール方法やバージョン情報

### トランスクリプトアライメントという選択

この研究では、**トランスクリプトアライメント**を選択しました。

トランスクリプトアライメントとは、リードをトランスクリプト配列（`transcripts.fa`）にマッピングする方法です。

なぜトランスクリプトアライメントを選んだのか？

1. **polyesterで生成したリードは、トランスクリプトから直接生成されている**
   - トランスクリプトから生成されたリードなので、トランスクリプトにマッピングするのが自然

2. **スプライスジャンクションを考慮する必要がない**
   - ゲノムアライメントでは、スプライスジャンクション（エクソンとイントロンの境界）を考慮する必要があるが、トランスクリプトアライメントでは不要

3. **トランスクリプトインデックスは軽量**
   - ゲノム全体（約1GB）ではなく、トランスクリプト（14遺伝子）だけなので、インデックスが軽量で、メモリ消費が少ない

<!-- 図3挿入位置：上半分に「ゲノムアライメント（巨大なゲノム＋スプライスをまたぐリード）」、下半分に「トランスクリプトアライメント（短めの14遺伝子セット）」を並べて比較する図。今回のパイプラインでは下側だけを使っていることを強調する。 -->

### マッピング率99.99%の意味

アライメントを実行すると、**マッピング率99.99%**という結果が得られました。

これは、**設計通りのデータが生成された証拠**です。

polyesterで生成したリードは、トランスクリプトから直接生成されています。そのため、トランスクリプトにマッピングする際、ほぼ100%マップされるのは当然です。

もし、マッピング率が低ければ、データ生成に問題があった可能性があります。99.99%という高いマッピング率は、**「シミュレーションデータが正しく生成された」**ことを示しています。

**実際のアライメント統計**：

19サンプルすべてについてアライメントを実行した結果、以下の統計が得られました：

| 指標 | 平均 | 範囲 |
|------|------|------|
| サンプルあたり総リード数 | 9,997,166 | 9,976,612 - 10,016,044 |
| マップされたリード（%） | 99.99 | 99.99 - 99.99 |
| ユニークマップされたリード（%） | 99.99 | 99.99 - 99.99 |

**解釈**：
- **総リード数**：各サンプルで約1000万リードが生成され、設計通り（サンプルあたり1000万リード）と一致
- **マッピング率**：全サンプルで99.99%と一貫して高く、polyesterで生成したリードがトランスクリプト参照に完全にマッピングされたことを示す
- **ユニークマッピング率**：99.99%と非常に高く、リードが複数の遺伝子に曖昧にマップされることなく、明確に1つのトランスクリプトにマップされたことを示す

この高いマッピング率は、**「シミュレーションデータが正しく生成され、アライメント処理が正常に完了した」**ことを示す重要な指標です。実際のRNA-seqデータでは、マッピング率は通常70-90%程度ですが、今回のシミュレーションデータでは、リードがトランスクリプトから直接生成されているため、ほぼ100%のマッピング率が達成されました。

---

## リードカウントの哲学

### なぜカスタム関数が必要だったのか？

通常、RNA-seq解析では`featureCounts`というツールを使ってリードをカウントします。しかし、この研究では、**カスタム関数**を使いました。

なぜカスタム関数が必要だったのか？

`featureCounts`は、**ゲノム座標に基づいてリードをカウントする**ツールです。しかし、トランスクリプトアライメントのBAMファイルには、ゲノム座標がありません。代わりに、トランスクリプトIDがリファレンス名として記録されています。

そのため、**トランスクリプトIDを直接カウントする**カスタム関数が必要でした。

👉 **BAM/SAM形式の詳細**：[SAM/BAM形式の説明](https://samtools.github.io/hts-specs/SAMv1.pdf) - アライメント結果の標準フォーマットの仕様

### リードカウントの意味

リードカウントは、**各遺伝子にマップされたリード数を数える**処理です。

リード数が多い = その遺伝子が多く発現している

これは、RNA-seq解析の基本原理です。リード数を数えることで、遺伝子発現量を定量化できます。

<!-- 図4挿入位置：BAMファイル中の各リード行が「RiosWingBMP1」「RiosToxinA1」などのIDごとに束ねられ、最終的に genes × samples のカウントマトリクスに集約される様子を示すパイプライン図。 -->

### カウントマトリクスの完成

リードカウントが完了すると、**カウントマトリクス**が完成します。

カウントマトリクスは、**各遺伝子が各サンプルでどれだけ発現しているか**を表す表です。

例えば：
- **RiosWingBMP1**：オス翼サンプルで約500リード、メス翼サンプルで約60リード
- **RiosToxinA1**：メス毒腺サンプルで約500リード、オス毒腺サンプルで約30リード

**実際のカウントマトリクスの特徴**：

19サンプル×14遺伝子のカウントマトリクスが完成しました。このマトリクスには、各遺伝子が各サンプルでマップされたリード数が記録されています。

**主要なパターン**（実際の解析結果から）：
- **RiosWingBMP1**：
  - オス翼サンプル（M_Wing_1, M_Wing_2, M_Wing_3）で高カウント
  - メス翼サンプル（F_Wing_1, F_Wing_2）で低カウント
  - 設計通りの性特異的発現パターンが確認される
  
- **RiosToxinA1**：
  - メス毒腺サンプル（F_Toxin_1, F_Toxin_2）で高カウント
  - オスサンプルで低カウント
  - 設計通りの性特異的発現パターンが確認される
  
- **ACTB_Rios**（ハウスキーピング遺伝子）：
  - 全サンプルで一貫して高カウント
  - 正規化コントロールとして機能

このように、**設計通りの発現パターン**が、カウントマトリクスに反映されています。このカウントマトリクスは、次回の統計解析（DESeq2）の入力データとなります。

---

## カウントマトリクスが完成

### データの準備が整った

アライメントとカウントが完了すると、**カウントマトリクス**が完成します。

カウントマトリクスは、19サンプル×14遺伝子の表で、各セルにはリード数が記録されています。

これで、RNA-seq解析の準備が整いました。

### 設計通りのデータが得られた

カウントマトリクスを見ると、**設計通りの発現パターン**が確認できます。

例えば：
- オス翼サンプルでは、RiosWingBMP1が高発現
- メス毒腺サンプルでは、RiosToxinA1が高発現
- 全サンプルで、ACTB_Riosが一定に発現

これにより、**「もしリオス科が実在したら、このような発現パターンになる」**という仮説を、データとして検証できます。

### 次のステップへ

カウントマトリクスが完成したら、次は**統計解析**を始めます。

統計解析は、**「オスとメスで発現量に差があるか」**を、統計的に検定する処理です。

「統計検定とは何か？」「p値とFDRとは何か？」「DESeq2とは何か？」

次回は、これらの疑問に答えながら、統計的に性差を検出する過程を覗いてみましょう。
